{% assign current_url = page.url %}
{% assign main_category = page.categories | first %}
{% assign all_posts = site.posts | where_exp: "post", "post.categories.first == main_category" %}

<script defer src="{{ '/assets/js/data/category-article-tree.js' | relative_url }}"></script>

<div id="category-article-tree">
<!-- 显示/隐藏按钮 -->
<aside class="category-tree-toggle-container">
  <button id="category-tree-toggle" class="category-tree-toggle-btn" type="button" aria-expanded="true" aria-controls="posts-list">
    <i id="category-tree-toggle-icon" class="fas fa-bars"></i>
  </button>
</aside>

<div class="posts-list category-tree-hidden" id="posts-list">
  <h3>{{ site.data.locales[lang].post.list.posts_list }}</h3>

  <!-- 按主类别分组 -->
  {% assign sub_categories = all_posts | map: "categories" | uniq %}

  <h4>{{main_category}}</h4>

  {% for cat in sub_categories %}
    {% if cat == main_category %}
      {% continue %} <!-- 过滤主类别 -->
    {% endif %}

    {% assign category_posts = all_posts | where_exp: "post", "post.categories contains cat" %}
    
    <div class="category-group" data-category="{{ cat | slugify }}">
      <div class="category-header">
        <button class="collapse-toggle" type="button" aria-expanded="true" aria-controls="category-{{ forloop.index }}">
          <span class="toggle-icon">▼</span>
          <h5 class="category-title">{{ cat }}</h5>
          <span class="article-count">({{ category_posts | size }} {{site.data.locales[lang].post.list.pian}})</span>
        </button>
      </div>

      <div class="category-content" id="category-{{ forloop.index }}">
        <ul class="article-list">
          {% for post in category_posts %}
            <li class="article-item {% if post.url == current_url %}current-article{% endif %}">
              <a href="{{ post.url }}" class="article-link">
                {{ post.title }}
                {% if post.categories.size > 1 %}
                  <span class="subcategory-badge">
                    {% for subcat in post.categories offset:1 %}
                      {{ subcat }}{% unless forloop.last %}, {% endunless %}
                    {% endfor %}
                  </span>
                {% endif %}
              </a>
              <span class="article-date">{{ post.date | date: "%Y-%m-%d" }}</span>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endfor %}
</div>
</div>
