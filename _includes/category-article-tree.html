{% assign current_url = page.url %}
{% assign main_category = page.categories | first %}
{% assign all_posts = site.posts | where_exp: "post", "post.categories.first == main_category" %}

<div id="category-article-tree">
<!-- 显示/隐藏按钮 -->
<aside class="category-tree-toggle-container">
  <button id="category-tree-toggle" class="category-tree-toggle-btn" type="button" aria-expanded="true" aria-controls="posts-list">
    <i id="category-tree-toggle-icon" class="fas fa-bars"></i>
  </button>
</aside>

<div class="posts-list category-tree-hidden" id="posts-list">
  <h3>{{ site.data.locales[lang].post.list.posts_list }}</h3>

  <!-- 按主类别分组 -->
  {% assign sub_categories = all_posts | map: "categories" | uniq %}

  <h4>{{main_category}}</h4>

  {% for cat in sub_categories %}
    {% if cat == main_category %}
      {% continue %} <!-- 过滤主类别 -->
    {% endif %}

    {% assign category_posts = all_posts | where_exp: "post", "post.categories contains cat" %}
    
    <div class="category-group" data-category="{{ cat | slugify }}">
      <div class="category-header">
        <button class="collapse-toggle" type="button" aria-expanded="true" aria-controls="category-{{ forloop.index }}">
          <span class="toggle-icon">▼</span>
          <h5 class="category-title">{{ cat }}</h5>
          <span class="article-count">({{ category_posts | size }} {{site.data.locales[lang].post.list.pian}})</span>
        </button>
      </div>

      <div class="category-content" id="category-{{ forloop.index }}">
        <ul class="article-list">
          {% for post in category_posts %}
            <li class="article-item {% if post.url == current_url %}current-article{% endif %}">
              <a href="{{ post.url }}" class="article-link">
                {{ post.title }}
                {% if post.categories.size > 1 %}
                  <span class="subcategory-badge">
                    {% for subcat in post.categories offset:1 %}
                      {{ subcat }}{% unless forloop.last %}, {% endunless %}
                    {% endfor %}
                  </span>
                {% endif %}
              </a>
              <span class="article-date">{{ post.date | date: "%Y-%m-%d" }}</span>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endfor %}
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  /*************** 文章列表功能 ***************/
  // 获取所有折叠切换按钮
  const collapseToggles = document.querySelectorAll('.collapse-toggle');

  // 为每个按钮添加点击事件
  collapseToggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const categoryGroup = this.closest('.category-group');
      const isCollapsed = categoryGroup.classList.contains('collapsed');

      // 切换折叠状态
      if (isCollapsed) {
        categoryGroup.classList.remove('collapsed');
        this.setAttribute('aria-expanded', 'true');
      } else {
        categoryGroup.classList.add('collapsed');
        this.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // 保存折叠状态的函数
  function saveCollapseState() {
    const states = {};
    document.querySelectorAll('.category-group').forEach(group => {
      const category = group.dataset.category;
      states[category] = group.classList.contains('collapsed');
    });
    localStorage.setItem('categoryCollapseStates', JSON.stringify(states));
  }

  // 恢复折叠状态的函数
  function restoreCollapseState() {
    const savedStates = localStorage.getItem('categoryCollapseStates');
    if (savedStates) {
      const states = JSON.parse(savedStates);
      document.querySelectorAll('.category-group').forEach(group => {
        const category = group.dataset.category;
        if (states[category]) {
          group.classList.add('collapsed');
          const toggle = group.querySelector('.collapse-toggle');
          toggle.setAttribute('aria-expanded', 'false');
        }
      });
    }
  }

  // 为每个折叠组添加状态变化监听
  document.querySelectorAll('.category-group').forEach(group => {
    group.addEventListener('transitionend', saveCollapseState);
  });

  // 页面加载时恢复状态
  restoreCollapseState();

  // 添加键盘支持
  collapseToggles.forEach(toggle => {
    toggle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
    });

  /*************** 滚动到当前文章的功能 ***************/
  function scrollToCurrentArticle() {
    const currentArticle = document.querySelector('.current-article');
    const postsList = document.getElementById('posts-list');

    if (!currentArticle || !postsList) return;

    // 检查是否需要滚动（列表是否超过最大高度）
    const hasScrollbar = postsList.scrollHeight > postsList.clientHeight;

    if (!hasScrollbar) {
      // 如果没有滚动条，不需要滚动
      return;
    }

    // 计算当前文章在列表中的位置
    const articleRect = currentArticle.getBoundingClientRect();
    const listRect = postsList.getBoundingClientRect();

    // 计算当前文章相对于列表的顶部位置
    const articleTopRelative = articleRect.top - listRect.top + postsList.scrollTop;

    // 计算列表的可视区域高度
    const listHeight = postsList.clientHeight;

    // 计算目标滚动位置（使当前文章位于列表中部）
    const targetScrollTop = articleTopRelative - (listHeight / 2) + (articleRect.height / 2);

    // 限制滚动范围
    const maxScrollTop = postsList.scrollHeight - listHeight;
    const boundedScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));

    // 平滑滚动到目标位置
    postsList.scrollTo({
      top: boundedScrollTop,
      behavior: 'smooth'
    });
  }

  // 页面加载时自动滚动到当前文章（如果文章列表可见）
  setTimeout(() => {
    if (categoryArticleTree.classList.contains('category-tree-visible')) {
      scrollToCurrentArticle();
    }
  }, 500);

  // 监听文章列表的显示状态变化
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        if (categoryArticleTree.classList.contains('category-tree-visible')) {
          // 给一点延迟确保CSS过渡完成
          setTimeout(() => {
            scrollToCurrentArticle();
          }, 100);
        }
      }
    });
  });

  observer.observe(categoryArticleTree, {
    attributes: true,
    attributeFilter: ['class']
  });
});

  /*************** 显示/隐藏整个文章列表的功能 ***************/
  const categoryTreeToggle = document.getElementById('category-tree-toggle');
  const categoryArticleTree = document.getElementById('posts-list');
  const categoryTreeToggleIcon = document.getElementById('category-tree-toggle-icon');

  // 初始化状态
  let isTreeVisible = false;

  // 切换显示/隐藏状态
  function toggleCategoryTree() {
    isTreeVisible = !isTreeVisible;

    if (isTreeVisible) {
      categoryArticleTree.classList.add('category-tree-visible');
      categoryArticleTree.classList.remove('category-tree-hidden');
      categoryTreeToggle.setAttribute('aria-expanded', 'true');
      categoryTreeToggleIcon.classList.add('fa-times');
      categoryTreeToggleIcon.classList.remove('fa-bars');
    } else {
      categoryArticleTree.classList.add('category-tree-hidden');
      categoryArticleTree.classList.remove('category-tree-visible');
      categoryTreeToggle.setAttribute('aria-expanded', 'false');
      categoryTreeToggleIcon.classList.add('fa-bars');
      categoryTreeToggleIcon.classList.remove('fa-times');
    }
  }

  // 绑定点击事件
  categoryTreeToggle.addEventListener('click', toggleCategoryTree);
  
  // 添加键盘支持
  categoryTreeToggle.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggleCategoryTree();
    }
  });
</script>